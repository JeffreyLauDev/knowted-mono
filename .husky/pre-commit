#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks for monorepo..."

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if server files changed
if echo "$CHANGED_FILES" | grep -q "^server/"; then
  echo "ğŸ“¦ Server files changed - running checks..."
  cd server
  
  echo "ğŸ”§ Running TypeScript type checking..."
  pnpm run build || {
    echo "âŒ TypeScript type check failed"
    exit 1
  }
  
  echo "ğŸ§ª Running unit tests..."
  pnpm test:ci || {
    echo "âŒ Tests failed"
    exit 1
  }
  
  cd ..
fi

# Check if client files changed
if echo "$CHANGED_FILES" | grep -q "^client/"; then
  echo "ğŸ“¦ Client files changed - running checks..."
  cd client
  
  echo "ğŸ”§ Running TypeScript type checking..."
  pnpm run build || {
    echo "âŒ TypeScript type check failed"
    exit 1
  }
  
  echo "ğŸ§ª Running unit tests..."
  pnpm test || {
    echo "âŒ Tests failed"
    exit 1
  }
  
  cd ..
fi

# Check if aiagent files changed
if echo "$CHANGED_FILES" | grep -q "^aiagent/"; then
  echo "ğŸ“¦ AI Agent files changed - running checks..."
  cd aiagent
  
  # Check if virtual environment exists
  if [ ! -d "venv" ]; then
    echo "âš ï¸  Virtual environment not found. Skipping AI agent checks."
  else
    echo "ğŸ”§ Running Python syntax check..."
    source venv/bin/activate
    python -m py_compile $(find . -name "*.py" -not -path "./venv/*" -not -path "./__pycache__/*") || {
      echo "âŒ Python syntax check failed"
      exit 1
    }
  fi
  
  cd ..
fi

echo "âœ… All pre-commit checks passed!"

